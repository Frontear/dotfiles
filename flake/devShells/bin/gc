#!/usr/bin/env bash

if [ -z "$1" ]; then
  echo "Usage: gc <gens|all>" >> /dev/stderr
  exit 1
fi

GENS=N
ALL=N

if [ "$1" = "gens" ]; then
  GENS=Y
fi

if [ "$1" = "all" ]; then
  ALL=Y
  GENS=Y
fi

if [ "$GENS" = "N" ] && [ "$ALL" = "N" ]; then
  echo "error: invalid option, must be either 'gens', or 'all'" >> /dev/stderr
  exit 1
fi

if [ "$ALL" = "Y" ]; then
  echo "Deleting all direnv roots..." > /dev/stderr
  find "$HOME" -type d -name ".direnv" -exec rm -rf {} +

  echo "Deleting all nix build out-links..." > /dev/stderr
  find "$HOME" -type l -name "result" -exec rm -f {} +
fi

if [ "$GENS" = "Y" ]; then
  LATEST_SYSTEM=$(readlink -f "/nix/var/nix/profiles/system")
  LATEST_HM=$(readlink -f "$HOME/.local/state/nix/profiles/home-manager")

  echo "Deleting all old system generations..." > /dev/stderr
  for p in /nix/var/nix/profiles/system*; do
    if [ "$(readlink -f $p)" != "$LATEST_SYSTEM" ]; then
      sudo rm -f "$p"
    fi
  done

  echo "Deleting all old home-manager generations..." > /dev/stderr
  for p in $HOME/.local/state/nix/profiles/home-manager*; do
    if [ "$(readlink -f $p)" != "$LATEST_HM" ]; then
      rm -f "$p"
    fi
  done
fi

sudo nix-collect-garbage -d
sudo nix-store --optimise
sudo /run/current-system/bin/switch-to-configuration switch
